# Historical Context for Portunus
Why does this exist? Aren't existing tools good enough? This document intends to capture the rationale behind implementing Yet Another World Of Warcraft Tool.

Optimal gameplay in the MMO World of Warcraft (WOW) has been studied fairly extensively for nearly two decades by a number of researchers, collectively known as "theorycrafters." Over the course of the game's history, and multiple expansion packs, this community has pieced together tribal knowledge and shared information on "how to play" each of the game's class and specialization combinations.

The game has traditionally provided three roles for players to choose. Highly armored "tanks" actively keep the attacking enemies focused on them, "healers" ensure that the group remains alive until end of combat, and "direct damagers" - players whose job it is to deal damage as quickly as possible to the enemies - fling spells and swing swords at the baddies. In this last role, the traditional metric by which we distinguish good players from bad players is "DPS", or "damage per second". The implicit understanding here is that a player who does more DPS than another player, all else equal, is a "better" player. Obviously, in real-world experience, DPS is not the only important metric to evaluate players; often there are other useful things being done such as crowd control, dispels, positioning, etc - but barring other signals, DPS is the standard metric on which players are evaluated.

Like in many other games, there are sub-role classifications within these three roles (crowd controller, disabler, hybrid heal/damage roles, etc) but these three (heal, tank, DPS) represent the MMO "holy trinity". This group combination (heal/tank/dps) is what end-game player-vs-environment group content is balanced around.

Although optimization for healing and tanking is certainly an interesting problem, the performance of players in those roles is much harder to evaluate than the performance of a damage-dealing class. Traditional tools have largely avoided exploring this space, due to the complexity of the control policies required and the extra simulation fidelity necessary to capture the nuances of the non-damaging roles. Additionally, it is uniquely challenging to simulate healing, as oftentimes with perfect play (as any simulation will generally assume), DPS players are able to take close to zero effective damage during an encounter - the healer's role is one of "fixing mistakes" rather than being actively necessary to complete an encounter succesfully, so there is an implicit problem with simulating their impact when most damage is avoidable.

Additionally, it does not always make sense to optimize for raw health-per-second throughput, as healing is largely a zero-sum game in high level group play: there is only so much damage going out to a group, and a finite set of healers to handle it. Healers optimizing for pure throughput will find themselves running out of resources towards the end of a fight; where healing is generally most important. Additionally, not all damage is equally important to heal quickly: the relative danger posed by a 10 damage spike when a player is at 11 health is much higher than the same 10 damage spike when a player is at 100 health.

Similarly, tanking is not so easily quantifiable: a good tank will simultaneously maximize their chances of staying alive while optimizing their damage, which poses a tradeoff in optimization space: a multi-objective problem with sometimes directly conflicting optimization goals. Tanks end up making a gearing choice between "offensive" and "defensive" profiles, or select an offensive or defensive action that consumes the same resource (a protection warrior can spend rage on offensive "revenge" versus defensive "ignore pain", for example). In the past, theorycrafters have developed policies and configurations for playing tanks "defensively" as well as "offensively", but evaluating the goodness of such policies has historically been out of scope for nearly all theorycrafting projects. In the mid 2010s, there was an attempt to unify some of these tank-specific metrics with the invention of the Theck Meloree Index, but this proved opaque and not easily understood by end users, and has largely been left by the wayside by the Simulationcraft developer community.

Given the complexities mentioned above with simulation and optimization for healers and tanks, we explicitly choose to NOT focus on these roles. Instead, we concern ourselves in this work with the (already) herculean task of optimization across gameplay choices for "damage dealing" roles.

In fact, the entirety of the Portunus project can be boiled down to the following problem: what choices can a damage dealer make to do as much damage as possible over the course of that fight? Equivalently, what choices can a damage dealer make to end a fight as quickly as possible?

## Existing Work
There already exist tools that have attempted to answer many of these questions, but each of these tools has drawbacks. There is a rich history of spreadsheets and models, as well as rudimentary markov chain simulation for various classes, but by far the most successful project in the history of World of Warcraft has been SIMC, or "SimulationCraft". To this author's knowledge, SIMC was the first project that looked at damage optimization as a black-box simulation problem, and it was this new approach to the theorycrafting problem that propelled it past all of the other determinstic spreadsheet-type tools (e.g. Rawr). There have been other attempts to model the game as a simulation (Ask Mr Robot, for one) but these other attempts have generally been poorly received by gamers due to their lack of transparency and community buy-in.

One fundamental issue that all of the existing tools have is their focus on optimization for a SINGLE PLAYER - you. Our simulator is no different - I think a nice idea for further work would be to to tackle a slightly harder problem: rather than optimization for individual players, we seek to optimize GROUP behavior: what choices and policies can a group select to maximize their probability of finishing a Mythic Keystone speedrun as quickly as possible. Here, the success metric wouldn't just be "maximize DPS", but rather "minimize Total Time" - such a tool might be very useful for MDI teams! Indeed, such a tool could take as input a "dungeon plan" - a collection of encounters (either boss encounters, or trash encounters) along with their setup time, and travel time between them. Such a simulator could allow us to process a FULL GROUP as they progress through the dungeon and defeat enemies. 

## Problem Description
DPS optimization is a classic planning problem, with an interesting twist. At a very abstract high level, there are effectively two planning components under the control of a player. These two components, loosely, "pre-combat configuration" and "mid-combat gameplay action/control policy".

The interesting twist present in this problem is that choices made during the pre-combat configuration phase tend to affect optimal decisions in the mid-combat gameplay phase. For example, some action/control policies favor configurations with different stat balances or talent choices (maybe you have a spell that gets better and better with more critical strike rating on your gear, so you would want to cast that spell more frequently when you have a lot of crit rating, but almost never if your crit rating is low).

A very specific historical example of this conundrum (pre-combat configuration decisions influencing mid-combat action selection) is the Assassination Rogue: at the beginning of the Battle for Azeroth expansion, there were largely considered to be two "viable" but distinct approachs to playing the assassination rogue - the "poison" build and the "bleed" build. The poison build required a large amount of mastery, because mastery (at the time) increased poison damage. If the rogue had a random gear configuration, it's unlikely that they would have enough mastery for the "poison" build to be good, but if they _specifically_ planned on using the poison build, they could set up a gearset with enough mastery to make it better than the "bleed" build.

Another piece of complexity is challenging to overcome: both of these components (offline- and online-planning) are thoroughly influenced by parameters of the encounter being simulated. The theorycrafting community has traditionally constructed different static player configurations and action policies for encounters that feature multiple persistent enemies ("AOE", or "area of effect", a term meaning an emphasis on abilities which do damage to multiple targets at once) and encounters that feature a single, high-health enemy ("Patchwork", named after a canonical target-dummy-style example enemy from the Naxxramas raid). However, this feature in SIMC has largely been underutilized (very few players construct their own encounters), and many players make decisions solely on the results of a static, one-target encounter that is widely criticized as being non-representative of true, in-game combat scenarios.

Any new approach to automatically solve the character planning + policy discovery problems, therefore, ought to take ALL THREE parameters into account: pre-fight player configuration, mid-fight player control policy, and encounter script details. 

In theory, one could construct a "fixed encounter" script that corresponds to your group's intended run through a keystone dungeon (and in fact, there's a [great weakaura](https://wago.io/Yya4XBbl-) called "MDT SIM" that does just this - it exports a file for use in SIMC that approximately matches your pull sequencing). In practice, however, a mythic keystone dungeon run will have a loose "script" laid out as an MDT route, but deviations due to errors are frequent, and a lot of the skill differentiation present in mythic plus comes from a player's ability to adapt on the fly to unplanned situations. In practice, therefore, our tool will NOT assume a fixed encounter script, but attempt to react appropriately to the existing game state over the course of combat.

The formalization we need is this: our goal as a DPS in a keystone speedrun is to minimize the expected value of the objective function `CombatTimeTaken(mid-combat action policy | pre-combat configuration)`. Note that in practice, the way that we accomplish this is by doing "priority damage" - a given pull takes as long to finish as the highest health target is alive, so we want to preferentially do damage to the target with the highest time-to-live. As a proxy for minimizing CombatTime, we can also seek to maximize PriorityDamage, where "priority" is somewhat tricky to define. Additionally, please note that we're FIXING the pre-combat configuration and conditioning over it.

So what does a pre-combat configuration look like, exactly?

### Pre-combat (static) Configuration
First, players need to make static choices about their character before combat ever begins, split into "equipment choices" and "talent choices". 

#### Equipment
Players have a number of empty inventory slots on their character when it is first created - these are slots like "helmet", "shoulders", "rings", "trinkets", "weapons", etc. A complete "gear configuration" is a mapping from each slot to a corresponding item that is equippable in that slot. Each damage specialization is constrained to using a subset of gear: a fury warrior generally does not wear cloth armor, and a shadow priest generally does not use a shield. Many items have synergistic effects with other items (i.e. item "tier sets" may impact gameplay in major ways: traditionally, the role of "raid tier set bonuses" has been to provide a gameplay-changing bonus to a specific player ability).

Additionally, some items (usually trinkets or weapons) have a random chance during combat to produce a magical effect (this is called a "proc", short for "programmed random occurrence"). Some items have an "on-use" ability that provides a powerful effect whose timing is controllable by a player. Using such items will be controlled by the mid-combat action policy.

Some items (legendary items) impact the behavior of player abilities entirely, and can provide a static on-equip effect similar in strength to player talents (see later section for more).

Most pieces of gear provide some amount of "primary stat" (intellect, agility, or strength) and some amount of "secondary stats" (versatility, mastery, critical strike, or haste). Each damage dealing specialization has a different interaction with these stats, but in combination, they form the core of player power progression: your character gets stronger when you get better items.

Finally, players can use non-equippable static consumable items, like food, augmenting runes, flasks, and scrolls, as well as numerous other dynamic consumable items (like potions) to get combat buffs.

#### Talents
Players have a choices of "talents" which further customize their specialization. In the current modern game implementation, characters can select from a vastly large combinatorial space of talents. This form of customization provides _OUTSIZED_ amounts of control on both optimal gearing as well as optimal policy selection. Some active talents grant new abilities to the player, while others passively modify the behavior of existing abilities completely. Some talents are better suited to multiple target combat, and other talents are optimized for single target damage. Players must choose their talents before combat starts, so they are part of the static configuration. In practice, some talents do not effect combat or damage meaningfully, and their impact can be ignored - these are generally called "utility" talents.


### Action Policy
The core goal of the Portunus project is the automatic generation of optimal mid-combat control policies through deep reinforcement learning. A common complaint with the old SIMC APLs ("action priority list") is that they were rarely optimized for mixed single-target damage and AOE damage, with profile maintainers sometimes electing to support both modes, but sometimes only focusing on single-target. 

We intend to support two types of policies, both of which are more flexible than the standard SIMC APL file. Both types of policies have *direct* access to the observable state from the simulation engine.

1) Explictly specified policies written using native code that has direct access to the simulation state observable to a player, rather than a hard-to-understand textual configuration language like the SIMC APLs.

2) Implicitly specified policies given via a neural network + MCTS/AlphaZero-style architecture: these implicit policies are essentially defined by their neural network weights and the tree search parameters. 

An `action policy` represents a mapping from game-state to action taken - in some sense, it's "how you play". For any given game state, we seek to identify the optimal action that maximizes a reward over a (potentially discounted) time horizon. We can formulate this problem as a classic "Markov Decision Problem": from each state `S`, there are a number of available actions `a`: for example, you might use ability "pistol shot", use ability "dispatch", or wait 100ms, etc. Each of these actions `a` has some transition probability of putting you into each of several potentially new states `S'`. You have some probability of receiving reward `R` from taking action `a` in state `S` and ending up in state `S'`: this is the damage value of the action at the time it was taken. 

The goal of framing this problem as a Markov Decision Problem is to allow us to use existing tools and solutions from the deep reinforcement learning community. Specifically, we're looking for the action for each state that maximizes the gamma-discounted reward in the limit as time goes to infinity. This model is a good match for our problem domain. If you're a Deep RL expert, please forgive the verbose description of an MDP here. One very strong technique for model-based reinforcement learning is AlphaZero - please see other resources for explanations. In particular, because our game is easily simulated, we are able to be very sample efficient. Technically, AlphaZero is not intended for use on problems with transition stochasticity (you could imagine the MTCS algorithm devolving to a linked-list style tree where you never revisit a child node) but because our problem has low amounts of stochasticity between states (usually, "did this crit or not" is the only randomness), it seems like it will work anyways.

## Similarity To Existing Tools In The Ecosystem / Prior Work
Several great tools have come about in the past several years to support World of Warcraft theorycrafters. Our goal is not necessarily to supplant these tools, but to build on their design success and incorporate their best parts. 

### Simulation Engine (SIMC)
Obviously, Simulationcraft is the "big daddy" of WoW Simulation. There have been probably hundreds of thousands of engineer-hours put into it at this point, and it's the gold standard for a reason. I am releasing Portunus not because I don't believe in SIMC, but because I believe we can do better - we can leverage the tools from DeepRL to go beyond static SIMC APLs into a better, higher DPS new world. Portunus is validated with SIMC APLs as the "human equivalent" line -- however, because the policies found by Portunus won't be "human playable" on their own, we need another piece of the puzzle:

### Gameplay Suggestion (HeroRotation)
Portunus' action policies should be exportable in the form of a rotation helper addon, like HeroRotation or Hekili or Ovale.
The idea here is to allow the addon to compute the "game state" by scraping information from the Wow LUA API, then use that state to run its control policy and suggest the next action to the player. We'll provide our own rotation helper that takes as input one of the trained control policies from a training run. 

### Web Frontend for Fine-tuning (Raidbots)
Raidbots is a tool developed by Seriallos that provides an incredibly intuitive frontend to the SIMC core simulation tool. It allows users to select various "tasks" and then guides them through using a wizard to setup the appropriate SIMC input code. Portunus intends to provide a similar front end webserver + queueing service to enable users to fine tune the core, base alpha zero network models on their specific character. Want to play a weird talent setup? Want to use other trinkets? No problem, eventually you'll be able to fine tune for your own use case.